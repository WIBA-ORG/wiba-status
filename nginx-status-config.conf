# Status subdomain configuration for status.wiba.dev
# This should be added to your main nginx config or included

# HTTP redirect for status subdomain
server {
	listen 80;
	server_name status.wiba.dev;
	return 301 https://$server_name$request_uri;
}

# HTTPS configuration for status subdomain
server {
	listen 443 ssl http2;
	server_name status.wiba.dev;

	# SSL configuration (adjust paths as needed)
	ssl_certificate /etc/letsencrypt/live/wiba.dev/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/wiba.dev/privkey.pem;
	ssl_trusted_certificate /etc/letsencrypt/live/wiba.dev/chain.pem;

	# SSL security settings
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
	ssl_prefer_server_ciphers off;

	# Security headers
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header Referrer-Policy "strict-origin-when-cross-origin" always;
	add_header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; script-src 'self'; img-src 'self' data:; connect-src 'self';" always;

	# Status page root directory
	root /var/www/status;
	index index.html;

	# Handle status page routes
	location / {
		try_files $uri $uri/ /index.html;
		expires 5m;
		add_header Cache-Control "public, must-revalidate";
	}

	# Status data API with CORS for GitHub Pages
	location /data/ {
		root /var/www/status;
		expires 1m;
		add_header Cache-Control "public, must-revalidate";
		add_header Access-Control-Allow-Origin "https://wiba-org.github.io";
		add_header Access-Control-Allow-Methods "GET";
	}

	# Assets with longer cache
	location /assets/ {
		root /var/www/status;
		expires 1d;
		add_header Cache-Control "public, immutable";
	}

	# Health check endpoint for monitoring
	location /health {
		access_log off;
		return 200 "OK\n";
		add_header Content-Type text/plain;
	}

	# Gzip compression
	gzip on;
	gzip_vary on;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

	# Log files
	access_log /var/log/nginx/status.wiba.dev.access.log;
	error_log /var/log/nginx/status.wiba.dev.error.log;
}